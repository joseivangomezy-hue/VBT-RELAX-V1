<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBT and Relax</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        input[type="range"] {
            accent-color: #3b82f6;
        }
        .editable-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            width: 70px;
            padding: 2px 4px;
            text-align: center;
            font-weight: 700;
            transition: all 0.2s;
        }
        .editable-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .tab-active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mode-active-profile {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            color: #1d4ed8 !important;
        }
        .mode-active-daily {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
            color: #047857 !important;
        }
        /* Suavizar el scroll general */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <!-- CONTENEDOR FIJO SUPERIOR -->
    <div class="sticky top-0 z-50 bg-slate-50/80 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto p-4 md:px-8 md:pt-6 md:pb-4">
            <header class="mb-4 text-center">
                <h1 class="text-3xl md:text-4xl font-black text-slate-800 tracking-tighter italic uppercase">VBT and Relax</h1>
                <p class="text-slate-500 text-sm font-medium">Análisis de Video & Auto-regulación</p>
            </header>

            <!-- EJERCICIOS (Navegación Fija) -->
            <section class="bg-white p-1.5 rounded-2xl custom-shadow border border-slate-100 max-w-3xl mx-auto">
                <div class="flex flex-wrap gap-1 bg-slate-100 p-1 rounded-xl">
                    <button onclick="switchExercise('bench')" id="tab-bench" class="flex-1 py-2 px-3 rounded-lg text-xs md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Press Banca</button>
                    <button onclick="switchExercise('squat')" id="tab-squat" class="flex-1 py-2 px-3 rounded-lg text-xs md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Sentadilla</button>
                    <button onclick="switchExercise('deadlift')" id="tab-deadlift" class="flex-1 py-2 px-3 rounded-lg text-xs md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Peso Muerto</button>
                    <button onclick="switchExercise('pullup')" id="tab-pullup" class="flex-1 py-2 px-3 rounded-lg text-xs md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Dominadas</button>
                </div>
            </section>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <main class="space-y-6">
            
            <!-- SECCIÓN DE CARGA DE VIDEO Y VELOCIDAD DE REFERENCIA -->
            <section class="bg-white p-4 rounded-2xl custom-shadow border border-slate-100">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-xl border border-blue-100 shrink-0 w-full md:w-auto">
                        <div class="text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-blue-400 uppercase leading-none">V-1RM Referencia</p>
                            <p id="v1rmDisplay" class="text-xl font-mono font-bold text-blue-700 leading-tight">0.17 m/s</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 flex-grow items-end w-full">
                        <div class="w-full md:w-32">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">FPS Video</label>
                            <input type="number" id="fpsInput" value="30" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex-grow">
                            <input type="file" id="videoInput" accept="video/*" class="hidden">
                            <button onclick="document.getElementById('videoInput').click()" class="w-full p-3.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition text-sm font-bold shadow-sm flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                Cargar Video del Levantamiento
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- COLUMNA IZQUIERDA: ANALIZADOR -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="bg-black rounded-2xl overflow-hidden shadow-2xl aspect-video relative flex items-center justify-center border-4 border-slate-200">
                        <video id="videoPlayer" class="w-full h-full object-contain" playsinline muted></video>
                        <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-md px-3 py-1 rounded-full text-white text-xs pointer-events-none flex gap-3 border border-white/10">
                            <span>Frame Actual: <b id="currentFrameDisplay">0</b></span>
                        </div>
                        <div id="processingOverlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-white hidden">
                            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p class="text-lg font-medium">Detectando FPS...</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex gap-2">
                                <!-- Botón Retroceder -->
                                <button onclick="stepFrame(-1)" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-700 transition" title="Retroceder 1 frame">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8.445 14.832A1 1 0 0010 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" />
                                    </svg>
                                </button>
                                <!-- Botón Avanzar -->
                                <button onclick="stepFrame(1)" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-700 transition" title="Avanzar 1 frame">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M11.555 14.832A1 1 0 0110 14V6a1 1 0 011.555-.832l6 4a1 1 0 010 1.664l-6 4z" />
                                    </svg>
                                </button>
                            </div>
                            <input type="range" id="frameSlider" value="0" min="0" step="1" class="flex-grow mx-4 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button onclick="markFrame('start')" class="py-3 px-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-xl hover:bg-emerald-100 transition flex flex-col items-center">
                                <span class="text-[10px] font-bold uppercase opacity-60">Inicio (Abajo)</span>
                                <span id="startFrameText" class="text-lg font-mono font-bold">--</span>
                            </button>
                            <button onclick="markFrame('end')" class="py-3 px-4 bg-rose-50 text-rose-700 border border-rose-100 rounded-xl hover:bg-rose-100 transition flex flex-col items-center">
                                <span class="text-[10px] font-bold uppercase opacity-60">Fin (Bloqueo)</span>
                                <span id="endFrameText" class="text-lg font-mono font-bold">--</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Carga Serie (kg)</label>
                                <input type="number" id="currentLoadInput" placeholder="Ej: 90" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recorrido (cm)</label>
                                <input type="number" id="distanceInput" value="45" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="mb-6">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-3 text-center">Modo de registro</p>
                            <div class="flex gap-2">
                                <button onclick="setRegMode('profile')" id="btnModeProfile" class="mode-active-profile flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-blue-200">
                                    Perfil Base
                                </button>
                                <button onclick="setRegMode('daily')" id="btnModeDaily" class="flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500">
                                    Test Diario
                                </button>
                            </div>
                        </div>

                        <button onclick="processCurrentMeasurement()" class="w-full py-4 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition font-black text-sm uppercase tracking-widest shadow-lg">
                            Registrar Levantamiento
                        </button>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: RESULTADOS -->
                <div class="lg:col-span-5 space-y-6">
                    
                    <!-- PERFIL EDITABLE -->
                    <section class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest" id="exerciseTitle">Perfil Base</h2>
                            <button onclick="clearCurrentExercise()" class="text-[10px] font-bold text-rose-400 hover:text-rose-600 uppercase">Reiniciar</button>
                        </div>
                        
                        <div class="space-y-3 mb-6" id="entriesList"></div>
                        
                        <div id="rmResultContainer" class="p-6 bg-slate-900 rounded-2xl text-white hidden shadow-lg overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold uppercase text-slate-400 mb-1">1RM Estimado</p>
                                    <div class="flex items-baseline gap-2">
                                        <span id="rmValue" class="text-5xl font-black">0.0</span>
                                        <span class="text-xl font-bold">kg</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold uppercase text-slate-400">Fiabilidad R²</p>
                                    <p id="r2Value" class="text-xl font-mono font-bold text-blue-400">0.000</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- RM DIARIO -->
                    <section id="dailyAdjustSection" class="bg-white p-6 rounded-2xl custom-shadow border-2 border-transparent hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm font-black text-emerald-600 uppercase tracking-widest flex items-center">
                                <span class="bg-emerald-100 p-1.5 rounded-lg mr-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </span>
                                Ajuste del Día
                            </h2>
                            <button onclick="resetDaily()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 uppercase">Borrar Test</button>
                        </div>

                        <div class="p-5 bg-emerald-600 rounded-xl text-white">
                            <div class="flex justify-between items-end mb-4">
                                <div>
                                    <p class="text-[10px] font-bold uppercase opacity-80 mb-1">1RM Real de Hoy</p>
                                    <div class="flex items-baseline gap-1">
                                        <span id="dailyRMValue" class="text-5xl font-black">0.0</span>
                                        <span class="text-sm font-bold">kg</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p id="dailyDiff" class="text-xs font-bold bg-white/20 px-2 py-1 rounded-lg">--</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/20">
                                <div>
                                    <p class="text-[9px] font-black uppercase opacity-60 leading-none mb-1 text-emerald-100">Velocidad</p>
                                    <div class="flex items-baseline gap-1">
                                        <span id="dailyMeasuredVel" class="text-2xl font-mono font-bold">0.00</span>
                                        <span class="text-[10px] font-bold uppercase">m/s</span>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-[9px] font-black uppercase opacity-60 leading-none mb-1 text-emerald-100">Carga Test</p>
                                    <div class="flex items-baseline gap-1">
                                        <span id="dailyMeasuredLoad" class="text-2xl font-bold">0</span>
                                        <span class="text-[10px] font-bold uppercase">kg</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- PLANIFICADOR -->
                    <section id="plannerSection" class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100 hidden">
                        <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 tracking-widest">Planificador RPE</h2>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-tight">Repeticiones</label>
                                <input type="number" id="planReps" value="5" min="1" max="12" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-tight">RPE Objetivo</label>
                                <select id="planRPE" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold">
                                    <option value="10">10</option><option value="9.5">9.5</option>
                                    <option value="9" selected>9</option><option value="8.5">8.5</option>
                                    <option value="8">8</option><option value="7.5">7.5</option>
                                    <option value="7">7</option><option value="6.5">6.5</option>
                                    <option value="6">6</option>
                                </select>
                            </div>
                        </div>
                        <div id="suggestedBox" class="p-6 bg-slate-50 rounded-2xl border border-slate-200 text-center transition-all">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-1 tracking-wider">Carga Sugerida</p>
                            <div class="flex justify-center items-baseline gap-2 text-slate-800">
                                <span id="suggestedWeight" class="text-5xl font-black">0.0</span>
                                <span class="text-lg font-bold">kg</span>
                            </div>
                            <p id="intensityInfo" class="text-[10px] text-slate-400 mt-2 font-black uppercase tracking-widest"></p>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        const V1RM = { bench: 0.17, squat: 0.30, deadlift: 0.15, pullup: 0.22 };
        const EX_NAMES = { bench: "Press Banca", squat: "Sentadilla", deadlift: "Peso Muerto", pullup: "Dominadas" };
        const RPE_CHART = {
            1: { 10: 100, 9.5: 98, 9: 96, 8.5: 94, 8: 92, 7.5: 91, 7: 89, 6.5: 87, 6: 85, 5.5: 83, 5: 81 },
            2: { 10: 96, 9.5: 94, 9: 92, 8.5: 91, 8: 89, 7.5: 87, 7: 85, 6.5: 83, 6: 81, 5.5: 79, 5: 77 },
            3: { 10: 92, 9.5: 91, 9: 89, 8.5: 87, 8: 85, 7.5: 84, 7: 82, 6.5: 80, 6: 78, 5.5: 76, 5: 74 },
            4: { 10: 89, 9.5: 87, 9: 85, 8.5: 84, 8: 82, 7.5: 80, 7: 79, 6.5: 77, 6: 75, 5.5: 73, 5: 71 },
            5: { 10: 86, 9.5: 84, 9: 82, 8.5: 80, 8: 79, 7.5: 77, 7: 76, 6.5: 74, 6: 72, 5.5: 70, 5: 68 },
            6: { 10: 83, 9.5: 81, 9: 79, 8.5: 78, 8: 76, 7.5: 74, 7: 73, 6.5: 71, 6: 69, 5.5: 67, 5: 65 },
            7: { 10: 80, 9.5: 78, 9: 76, 8.5: 75, 8: 73, 7.5: 71, 7: 70, 6.5: 68, 6: 66, 5.5: 64, 5: 62 },
            8: { 10: 77, 9.5: 75, 9: 73, 8.5: 72, 8: 70, 7.5: 68, 7: 67, 6.5: 65, 6: 63, 5.5: 61, 5: 59 },
            9: { 10: 75, 9.5: 73, 9: 71, 8.5: 69, 8: 67, 7.5: 65, 7: 64, 6.5: 62, 6: 60, 5.5: 58, 5: 56 },
            10: { 10: 72, 9.5: 70, 9: 68, 8.5: 66, 8: 64, 7.5: 63, 7: 61, 6.5: 59, 6: 57, 5.5: 55, 5: 53 },
            11: { 10: 69, 9.5: 67, 9: 65, 8.5: 63, 8: 62, 7.5: 60, 7: 59, 6.5: 57, 6: 55, 5.5: 53, 5: 51 },
            12: { 10: 67, 9.5: 65, 9: 63, 8.5: 61, 8: 60, 7.5: 58, 7: 57, 6.5: 55, 6: 53, 5.5: 51, 5: 49 }
        };

        const videoInput = document.getElementById('videoInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const frameSlider = document.getElementById('frameSlider');
        const fpsInput = document.getElementById('fpsInput');
        const entriesList = document.getElementById('entriesList');
        
        let currentExercise = 'bench';
        let registrationMode = 'profile'; 
        let allData = JSON.parse(localStorage.getItem('vbt_data')) || { bench: [], squat: [], deadlift: [], pullup: [] };
        let dailyRM = null;
        let profileRM = 0;
        let currentSlope = 0;
        let startFrame = null, endFrame = null;

        window.onload = () => switchExercise(currentExercise);

        function switchExercise(ex) {
            currentExercise = ex;
            Object.keys(EX_NAMES).forEach(key => document.getElementById(`tab-${key}`).classList.toggle('tab-active', key === ex));
            document.getElementById('v1rmDisplay').textContent = `${V1RM[ex].toFixed(2)} m/s`;
            document.getElementById('exerciseTitle').textContent = `Perfil: ${EX_NAMES[ex]}`;
            dailyRM = null;
            document.getElementById('dailyAdjustSection').classList.add('hidden');
            document.getElementById('suggestedBox').className = "p-6 bg-slate-50 rounded-2xl border border-slate-200 text-center transition-all";
            updateUI();
        }

        function setRegMode(mode) {
            registrationMode = mode;
            const bProfile = document.getElementById('btnModeProfile');
            const bDaily = document.getElementById('btnModeDaily');
            
            if (mode === 'profile') {
                bProfile.className = 'mode-active-profile flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-blue-200';
                bDaily.className = 'flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500';
            } else {
                bProfile.className = 'flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500';
                bDaily.className = 'mode-active-daily flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-emerald-200';
            }
        }

        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            videoPlayer.src = URL.createObjectURL(file);
            document.getElementById('processingOverlay').classList.remove('hidden');
            videoPlayer.onloadedmetadata = async () => {
                const fps = await detectFPS(videoPlayer);
                fpsInput.value = Math.round(fps);
                frameSlider.max = Math.floor(videoPlayer.duration * fps);
                document.getElementById('processingOverlay').classList.add('hidden');
            };
        });

        async function detectFPS(v) {
            return new Promise(res => {
                if (!v.requestVideoFrameCallback) return res(30);
                let f = [];
                const cb = (_, m) => {
                    if (m.mediaTime !== undefined) f.push(m.mediaTime);
                    if (f.length < 30) v.requestVideoFrameCallback(cb);
                    else { v.pause(); res(f.length ? 1/((f[f.length-1]-f[0])/f.length) : 30); }
                };
                v.play().then(() => v.requestVideoFrameCallback(cb)).catch(() => res(30));
            });
        }

        videoPlayer.addEventListener('timeupdate', () => {
            const f = Math.round(videoPlayer.currentTime * (parseFloat(fpsInput.value) || 30));
            document.getElementById('currentFrameDisplay').textContent = f;
            frameSlider.value = f;
        });

        frameSlider.addEventListener('input', () => videoPlayer.currentTime = frameSlider.value / (parseFloat(fpsInput.value) || 30));
        function stepFrame(d) { videoPlayer.currentTime += d / (parseFloat(fpsInput.value) || 30); }
        function markFrame(t) {
            const f = Math.round(videoPlayer.currentTime * (parseFloat(fpsInput.value) || 30));
            if (t === 'start') { startFrame = f; document.getElementById('startFrameText').textContent = f; }
            else { endFrame = f; document.getElementById('endFrameText').textContent = f; }
        }

        function processCurrentMeasurement() {
            if (startFrame === null || endFrame === null) return;
            const load = parseFloat(document.getElementById('currentLoadInput').value);
            if (isNaN(load) || load <= 0) return;
            
            const time = (endFrame - startFrame) / (parseFloat(fpsInput.value) || 30);
            const vel = (parseFloat(document.getElementById('distanceInput').value) / 100) / time;

            if (registrationMode === 'profile') {
                allData[currentExercise].push({ load, velocity: vel });
                localStorage.setItem('vbt_data', JSON.stringify(allData));
                updateUI();
            } else {
                if (allData[currentExercise].length < 2) return alert("Crea un perfil base primero");
                applyDailyAdjustment(load, vel);
            }
            startFrame = endFrame = null;
            document.getElementById('startFrameText').textContent = document.getElementById('endFrameText').textContent = "--";
        }

        function updateUI() {
            const entries = allData[currentExercise];
            if (!entries.length) {
                entriesList.innerHTML = `<p class="text-slate-400 text-xs italic text-center py-4">Sube videos de cargas bajas y medias para el perfil</p>`;
                document.getElementById('rmResultContainer').classList.add('hidden');
                document.getElementById('plannerSection').classList.add('hidden');
                return;
            }

            entriesList.innerHTML = entries.map((e, i) => `
                <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex flex-col">
                        <span class="text-[9px] font-black text-slate-400 uppercase">Carga (kg)</span>
                        <input type="number" value="${e.load}" onchange="editEntry(${i}, 'load', this.value)" class="editable-input">
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[9px] font-black text-slate-400 uppercase">Vel (m/s)</span>
                        <input type="number" step="0.01" value="${e.velocity.toFixed(2)}" onchange="editEntry(${i}, 'velocity', this.value)" class="editable-input font-mono">
                    </div>
                    <button onclick="removeEntry(${i})" class="text-rose-400 p-1 hover:bg-rose-50 rounded-lg transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>`).join('');

            if (entries.length >= 2) calcProfile();
            else {
                document.getElementById('rmResultContainer').classList.add('hidden');
                document.getElementById('plannerSection').classList.add('hidden');
            }
        }

        function editEntry(i, field, val) {
            allData[currentExercise][i][field] = parseFloat(val);
            localStorage.setItem('vbt_data', JSON.stringify(allData));
            updateUI();
        }

        function removeEntry(i) {
            allData[currentExercise].splice(i, 1);
            localStorage.setItem('vbt_data', JSON.stringify(allData));
            updateUI();
        }

        function calcProfile() {
            const entries = allData[currentExercise];
            const x = entries.map(e => e.velocity), y = entries.map(e => e.load), n = x.length;
            const sX = x.reduce((a, b) => a + b, 0), sY = y.reduce((a, b) => a + b, 0);
            const sXY = x.reduce((p, c, i) => p + (c * y[i]), 0), sXX = x.reduce((a, b) => a + (b * b), 0);
            
            const den = (n * sXX - sX * sX);
            if (den === 0) return;
            
            currentSlope = (n * sXY - sX * sY) / den;
            const intercept = (sY - currentSlope * sX) / n;
            
            const yM = sY/n;
            const ssT = y.reduce((a,v) => a + Math.pow(v-yM, 2), 0);
            const ssR = y.reduce((a,v,i) => a + Math.pow(v - (currentSlope*x[i] + intercept), 2), 0);
            const r2 = ssT === 0 ? 1 : 1 - (ssR/ssT);

            profileRM = currentSlope * V1RM[currentExercise] + intercept;
            
            document.getElementById('rmValue').textContent = profileRM.toFixed(1);
            document.getElementById('r2Value').textContent = r2.toFixed(3);
            document.getElementById('rmResultContainer').classList.remove('hidden');
            document.getElementById('plannerSection').classList.remove('hidden');
            
            updatePlan();
        }

        function applyDailyAdjustment(load, vel) {
            dailyRM = load + currentSlope * (V1RM[currentExercise] - vel);
            const diff = dailyRM - profileRM;
            const diffPct = (diff / profileRM) * 100;
            
            document.getElementById('dailyRMValue').textContent = dailyRM.toFixed(1);
            document.getElementById('dailyMeasuredVel').textContent = vel.toFixed(2);
            document.getElementById('dailyMeasuredLoad').textContent = load;
            document.getElementById('dailyDiff').textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}kg (${diffPct.toFixed(1)}%)`;
            document.getElementById('dailyDiff').className = `text-[10px] font-bold px-2 py-1 rounded-lg ${diff >= 0 ? 'bg-emerald-400/30' : 'bg-rose-400/30'}`;
            
            document.getElementById('dailyAdjustSection').classList.remove('hidden');
            document.getElementById('suggestedBox').className = "p-6 bg-emerald-50 rounded-2xl border-2 border-emerald-200 text-center transition-all";
            
            updatePlan();
        }

        function updatePlan() {
            const activeRM = dailyRM || profileRM;
            if (activeRM <= 0) return;
            const p = RPE_CHART[document.getElementById('planReps').value]?.[document.getElementById('planRPE').value] || 0;
            if (p > 0) {
                document.getElementById('suggestedWeight').textContent = (activeRM * (p / 100)).toFixed(1);
                document.getElementById('intensityInfo').textContent = `${p}% del RM ${dailyRM ? 'Diario' : 'Base'}`;
                document.getElementById('intensityInfo').className = `text-[10px] mt-2 font-black uppercase tracking-widest ${dailyRM ? 'text-emerald-600' : 'text-slate-400'}`;
                document.getElementById('suggestedWeight').parentElement.className = `flex justify-center items-baseline gap-2 ${dailyRM ? 'text-emerald-700' : 'text-slate-800'}`;
            }
        }

        function resetDaily() {
            dailyRM = null;
            document.getElementById('dailyAdjustSection').classList.add('hidden');
            document.getElementById('suggestedBox').className = "p-6 bg-slate-50 rounded-2xl border border-slate-200 text-center transition-all";
            updatePlan();
        }

        function clearCurrentExercise() {
            if(confirm("¿Borrar todo el perfil de este ejercicio?")) {
                allData[currentExercise] = [];
                localStorage.setItem('vbt_data', JSON.stringify(allData));
                switchExercise(currentExercise);
            }
        }

        document.getElementById('planReps').addEventListener('input', updatePlan);
        document.getElementById('planRPE').addEventListener('change', updatePlan);
    </script>
</body>
</html>
