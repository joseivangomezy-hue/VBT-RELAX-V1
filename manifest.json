<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBT and Relax</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        input[type="range"] {
            accent-color: #3b82f6;
        }
        .editable-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            width: 70px;
            padding: 2px 4px;
            text-align: center;
            font-weight: 700;
            transition: all 0.2s;
        }
        .editable-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .tab-active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mode-active-profile {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            color: #1d4ed8 !important;
        }
        .mode-active-daily {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
            color: #047857 !important;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <!-- CONTENEDOR FIJO SUPERIOR -->
    <div class="sticky top-0 z-50 bg-slate-50/80 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto p-4 md:px-8 md:pt-6 md:pb-4">
            <header class="mb-4 text-center">
                <h1 class="text-3xl md:text-4xl font-black text-slate-800 tracking-tighter italic uppercase">VBT and Relax</h1>
                <p class="text-slate-500 text-sm font-medium">An치lisis de Video & Auto-regulaci칩n</p>
            </header>

            <!-- NAVEGACI칍N (Pesta침as) -->
            <section class="bg-white p-1.5 rounded-2xl custom-shadow border border-slate-100 max-w-4xl mx-auto">
                <div class="flex flex-wrap gap-1 bg-slate-100 p-1 rounded-xl">
                    <button onclick="switchExercise('bench')" id="tab-bench" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Press Banca</button>
                    <button onclick="switchExercise('squat')" id="tab-squat" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Sentadilla</button>
                    <button onclick="switchExercise('deadlift')" id="tab-deadlift" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Peso Muerto</button>
                    <button onclick="switchExercise('pullup')" id="tab-pullup" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Dominadas</button>
                    <button onclick="switchExercise('history')" id="tab-history" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700 bg-slate-200/50">游늵 Progreso</button>
                </div>
            </section>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- VISTA DE ANALIZADOR (POR DEFECTO) -->
        <main id="analyzerView" class="space-y-6">
            
            <!-- SECCI칍N DE CARGA DE VIDEO Y VELOCIDAD DE REFERENCIA -->
            <section class="bg-white p-4 rounded-2xl custom-shadow border border-slate-100">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-xl border border-blue-100 shrink-0 w-full md:w-auto">
                        <div class="text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-blue-400 uppercase leading-none">V-1RM Referencia</p>
                            <p id="v1rmDisplay" class="text-xl font-mono font-bold text-blue-700 leading-tight">0.17 m/s</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 flex-grow items-end w-full">
                        <div class="w-full md:w-32">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">FPS Video</label>
                            <input type="number" id="fpsInput" value="30" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex-grow">
                            <input type="file" id="videoInput" accept="video/*" class="hidden">
                            <button onclick="document.getElementById('videoInput').click()" class="w-full p-3.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition text-sm font-bold shadow-sm flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                Cargar Video del Levantamiento
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- COLUMNA IZQUIERDA: ANALIZADOR -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="bg-black rounded-2xl overflow-hidden shadow-2xl aspect-video relative flex items-center justify-center border-4 border-slate-200">
                        <video id="videoPlayer" class="w-full h-full object-contain" playsinline muted></video>
                        <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-md px-3 py-1 rounded-full text-white text-xs pointer-events-none flex gap-3 border border-white/10">
                            <span>Frame Actual: <b id="currentFrameDisplay">0</b></span>
                        </div>
                        <div id="processingOverlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-white hidden">
                            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p class="text-lg font-medium">Detectando FPS...</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex gap-2">
                                <button onclick="stepFrame(-1)" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M8.445 14.832A1 1 0 0010 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" /></svg>
                                </button>
                                <button onclick="stepFrame(1)" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M11.555 14.832A1 1 0 0110 14V6a1 1 0 011.555-.832l6 4a1 1 0 010 1.664l-6 4z" /></svg>
                                </button>
                            </div>
                            <input type="range" id="frameSlider" value="0" min="0" step="1" class="flex-grow mx-4 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button onclick="markFrame('start')" class="py-3 px-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-xl hover:bg-emerald-100 transition flex flex-col items-center">
                                <span class="text-[10px] font-bold uppercase opacity-60">Inicio (Abajo)</span>
                                <span id="startFrameText" class="text-lg font-mono font-bold">--</span>
                            </button>
                            <button onclick="markFrame('end')" class="py-3 px-4 bg-rose-50 text-rose-700 border border-rose-100 rounded-xl hover:bg-rose-100 transition flex flex-col items-center">
                                <span class="text-[10px] font-bold uppercase opacity-60">Fin (Bloqueo)</span>
                                <span id="endFrameText" class="text-lg font-mono font-bold">--</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Carga Serie (kg)</label>
                                <input type="number" id="currentLoadInput" placeholder="Ej: 90" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recorrido (cm)</label>
                                <input type="number" id="distanceInput" value="45" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="mb-6">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-3 text-center">Modo de registro</p>
                            <div class="flex gap-2">
                                <button onclick="setRegMode('profile')" id="btnModeProfile" class="mode-active-profile flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-blue-200">Perfil Base</button>
                                <button onclick="setRegMode('daily')" id="btnModeDaily" class="flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500">Test Diario</button>
                            </div>
                        </div>

                        <button onclick="processCurrentMeasurement()" class="w-full py-4 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition font-black text-sm uppercase tracking-widest shadow-lg">Registrar Levantamiento</button>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: RESULTADOS R츼PIDOS -->
                <div class="lg:col-span-5 space-y-6">
                    <section class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest" id="exerciseTitle">Perfil Base</h2>
                        </div>
                        <div id="rmResultContainer" class="p-6 bg-slate-900 rounded-2xl text-white hidden shadow-lg overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold uppercase text-slate-400 mb-1">1RM Estimado</p>
                                    <div class="flex items-baseline gap-2">
                                        <span id="rmValue" class="text-5xl font-black">0.0</span>
                                        <span class="text-xl font-bold">kg</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold uppercase text-slate-400">Fiabilidad R</p>
                                    <p id="r2Value" class="text-xl font-mono font-bold text-blue-400">0.000</p>
                                </div>
                            </div>
                        </div>
                        <div id="noDataWarning" class="text-center py-6 text-slate-400 text-xs italic">A침ade al menos 2 levantamientos para generar el perfil.</div>
                    </section>

                    <section id="dailyAdjustSection" class="bg-white p-6 rounded-2xl custom-shadow border-2 border-transparent hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm font-black text-emerald-600 uppercase tracking-widest flex items-center">Ajuste del D칤a</h2>
                            <button onclick="resetDaily()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 uppercase">Borrar</button>
                        </div>
                        <div class="p-5 bg-emerald-600 rounded-xl text-white">
                            <p class="text-[10px] font-bold uppercase opacity-80 mb-1">1RM Real de Hoy</p>
                            <div class="flex items-baseline justify-between">
                                <span id="dailyRMValue" class="text-5xl font-black">0.0</span>
                                <p id="dailyDiff" class="text-xs font-bold bg-white/20 px-2 py-1 rounded-lg">--</p>
                            </div>
                        </div>
                    </section>

                    <section id="plannerSection" class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100 hidden">
                        <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 tracking-widest">Planificador</h2>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input type="number" id="planReps" value="5" class="p-3 bg-slate-50 border rounded-xl font-bold" title="Repeticiones">
                            <select id="planRPE" class="p-3 bg-slate-50 border rounded-xl font-bold">
                                <option value="10">RPE 10</option><option value="9.5">RPE 9.5</option><option value="9" selected>RPE 9</option><option value="8.5">RPE 8.5</option><option value="8">RPE 8</option>
                            </select>
                        </div>
                        <div id="suggestedBox" class="p-4 bg-slate-50 rounded-2xl border text-center">
                            <p id="suggestedWeight" class="text-4xl font-black text-slate-800">0.0 kg</p>
                            <p id="intensityInfo" class="text-[9px] text-slate-400 font-bold uppercase mt-1"></p>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <!-- VISTA DE HISTORIAL / PROGRESO -->
        <main id="historyView" class="hidden space-y-8 animate-in fade-in duration-500">
            <header class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase italic">Resumen de Perfiles</h2>
                    <p class="text-slate-500 text-sm">Estado actual de todos tus levantamientos principales.</p>
                </div>
                <button onclick="exportData()" class="px-4 py-2 bg-slate-800 text-white text-xs font-bold rounded-xl uppercase tracking-widest hover:bg-slate-700">Respaldar Datos</button>
            </header>

            <!-- Grid de RMs actuales -->
            <div id="rmGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Se rellena con JS -->
            </div>

            <!-- Listado Detallado Editable -->
            <div class="space-y-6">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Registros por Ejercicio</h3>
                <div id="exerciseHistoryLists" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Se rellena con JS -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const V1RM = { bench: 0.17, squat: 0.30, deadlift: 0.15, pullup: 0.22 };
        const EX_NAMES = { bench: "Press Banca", squat: "Sentadilla", deadlift: "Peso Muerto", pullup: "Dominadas" };
        const RPE_CHART = {
            1: { 10: 100, 9.5: 98, 9: 96, 8.5: 94, 8: 92, 7.5: 91, 7: 89, 6.5: 87, 6: 85, 5.5: 83, 5: 81 },
            2: { 10: 96, 9.5: 94, 9: 92, 8.5: 91, 8: 89, 7.5: 87, 7: 85, 6.5: 83, 6: 81, 5.5: 79, 5: 77 },
            3: { 10: 92, 9.5: 91, 9: 89, 8.5: 87, 8: 85, 7.5: 84, 7: 82, 6.5: 80, 6: 78, 5.5: 76, 5: 74 },
            4: { 10: 89, 9.5: 87, 9: 85, 8.5: 84, 8: 82, 7.5: 80, 7: 79, 6.5: 77, 6: 75, 5.5: 73, 5: 71 },
            5: { 10: 86, 9.5: 84, 9: 82, 8.5: 80, 8: 79, 7.5: 77, 7: 76, 6.5: 74, 6: 72, 5.5: 70, 5: 68 },
            6: { 10: 83, 9.5: 81, 9: 79, 8.5: 78, 8: 76, 7.5: 74, 7: 73, 6.5: 71, 6: 69, 5.5: 67, 5: 65 },
            7: { 10: 80, 9.5: 78, 9: 76, 8.5: 75, 8: 73, 7.5: 71, 7: 70, 6.5: 68, 6: 66, 5.5: 64, 5: 62 },
            8: { 10: 77, 9.5: 75, 9: 73, 8.5: 72, 8: 70, 7.5: 68, 7: 67, 6.5: 65, 6: 63, 5.5: 61, 5: 59 },
            9: { 10: 75, 9.5: 73, 9: 71, 8.5: 69, 8: 67, 7.5: 65, 7: 64, 6.5: 62, 6: 60, 5.5: 58, 5: 56 },
            10: { 10: 72, 9.5: 70, 9: 68, 8.5: 66, 8: 64, 7.5: 63, 7: 61, 6.5: 59, 6: 57, 5.5: 55, 5: 53 },
            11: { 10: 69, 9.5: 67, 9: 65, 8.5: 63, 8: 62, 7.5: 60, 7: 59, 6.5: 57, 6: 55, 5.5: 53, 5: 51 },
            12: { 10: 67, 9.5: 65, 9: 63, 8.5: 61, 8: 60, 7.5: 58, 7: 57, 6.5: 55, 6: 53, 5.5: 51, 5: 49 }
        };

        let currentExercise = 'bench';
        let registrationMode = 'profile'; 
        let allData = JSON.parse(localStorage.getItem('vbt_data')) || { bench: [], squat: [], deadlift: [], pullup: [] };
        let dailyRM = null;
        let startFrame = null, endFrame = null;

        const videoInput = document.getElementById('videoInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const frameSlider = document.getElementById('frameSlider');
        const fpsInput = document.getElementById('fpsInput');

        window.onload = () => switchExercise(currentExercise);

        function switchExercise(ex) {
            currentExercise = ex;
            
            // Actualizar Tabs UI
            ['bench', 'squat', 'deadlift', 'pullup', 'history'].forEach(key => {
                const el = document.getElementById(`tab-${key}`);
                if(el) el.classList.toggle('tab-active', key === ex);
            });

            if (ex === 'history') {
                document.getElementById('analyzerView').classList.add('hidden');
                document.getElementById('historyView').classList.remove('hidden');
                renderHistory();
            } else {
                document.getElementById('analyzerView').classList.remove('hidden');
                document.getElementById('historyView').classList.add('hidden');
                document.getElementById('v1rmDisplay').textContent = `${V1RM[ex].toFixed(2)} m/s`;
                document.getElementById('exerciseTitle').textContent = `Perfil: ${EX_NAMES[ex]}`;
                dailyRM = null;
                document.getElementById('dailyAdjustSection').classList.add('hidden');
                updateUI();
            }
        }

        function setRegMode(mode) {
            registrationMode = mode;
            const bProfile = document.getElementById('btnModeProfile');
            const bDaily = document.getElementById('btnModeDaily');
            if (mode === 'profile') {
                bProfile.className = 'mode-active-profile flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-blue-200';
                bDaily.className = 'flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500';
            } else {
                bProfile.className = 'flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500';
                bDaily.className = 'mode-active-daily flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-emerald-200';
            }
        }

        // --- L칍GICA DE VIDEO ---
        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            videoPlayer.src = URL.createObjectURL(file);
            videoPlayer.onloadedmetadata = () => {
                frameSlider.max = Math.floor(videoPlayer.duration * parseFloat(fpsInput.value));
            };
        });

        videoPlayer.addEventListener('timeupdate', () => {
            const f = Math.round(videoPlayer.currentTime * (parseFloat(fpsInput.value) || 30));
            document.getElementById('currentFrameDisplay').textContent = f;
            frameSlider.value = f;
        });

        frameSlider.addEventListener('input', () => videoPlayer.currentTime = frameSlider.value / (parseFloat(fpsInput.value) || 30));
        function stepFrame(d) { videoPlayer.currentTime += d / (parseFloat(fpsInput.value) || 30); }
        function markFrame(t) {
            const f = Math.round(videoPlayer.currentTime * (parseFloat(fpsInput.value) || 30));
            if (t === 'start') { startFrame = f; document.getElementById('startFrameText').textContent = f; }
            else { endFrame = f; document.getElementById('endFrameText').textContent = f; }
        }

        // --- PROCESAMIENTO ---
        function processCurrentMeasurement() {
            if (startFrame === null || endFrame === null) return;
            const load = parseFloat(document.getElementById('currentLoadInput').value);
            if (isNaN(load) || load <= 0) return;
            
            const time = (endFrame - startFrame) / (parseFloat(fpsInput.value) || 30);
            const vel = (parseFloat(document.getElementById('distanceInput').value) / 100) / time;

            if (registrationMode === 'profile') {
                allData[currentExercise].push({ load, velocity: vel, timestamp: Date.now() });
                localStorage.setItem('vbt_data', JSON.stringify(allData));
                updateUI();
            } else {
                const profile = calculateRM(currentExercise);
                if (!profile) return alert("Crea un perfil base primero");
                applyDailyAdjustment(load, vel, profile);
            }
            startFrame = endFrame = null;
            document.getElementById('startFrameText').textContent = document.getElementById('endFrameText').textContent = "--";
        }

        function calculateRM(ex) {
            const entries = allData[ex];
            if (entries.length < 2) return null;
            const x = entries.map(e => e.velocity), y = entries.map(e => e.load), n = x.length;
            const sX = x.reduce((a, b) => a + b, 0), sY = y.reduce((a, b) => a + b, 0);
            const sXY = x.reduce((p, c, i) => p + (c * y[i]), 0), sXX = x.reduce((a, b) => a + (b * b), 0);
            const den = (n * sXX - sX * sX);
            if (den === 0) return null;
            const slope = (n * sXY - sX * sY) / den;
            const intercept = (sY - slope * sX) / n;
            const rm = slope * V1RM[ex] + intercept;

            const yM = sY/n;
            const ssT = y.reduce((a,v) => a + Math.pow(v-yM, 2), 0);
            const ssR = y.reduce((a,v,i) => a + Math.pow(v - (slope*x[i] + intercept), 2), 0);
            return { rm, r2: ssT === 0 ? 1 : 1 - (ssR/ssT), slope };
        }

        function updateUI() {
            const profile = calculateRM(currentExercise);
            if (profile) {
                document.getElementById('rmValue').textContent = profile.rm.toFixed(1);
                document.getElementById('r2Value').textContent = profile.r2.toFixed(3);
                document.getElementById('rmResultContainer').classList.remove('hidden');
                document.getElementById('plannerSection').classList.remove('hidden');
                document.getElementById('noDataWarning').classList.add('hidden');
                updatePlan(profile.rm);
            } else {
                document.getElementById('rmResultContainer').classList.add('hidden');
                document.getElementById('plannerSection').classList.add('hidden');
                document.getElementById('noDataWarning').classList.remove('hidden');
            }
        }

        function applyDailyAdjustment(load, vel, profile) {
            dailyRM = load + profile.slope * (V1RM[currentExercise] - vel);
            const diff = dailyRM - profile.rm;
            document.getElementById('dailyRMValue').textContent = dailyRM.toFixed(1);
            document.getElementById('dailyDiff').textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}kg`;
            document.getElementById('dailyAdjustSection').classList.remove('hidden');
            updatePlan(dailyRM);
        }

        function updatePlan(activeRM) {
            const r = document.getElementById('planReps').value;
            const p = document.getElementById('planRPE').value;
            const intensity = RPE_CHART[r]?.[p] || 0;
            if (intensity > 0) {
                document.getElementById('suggestedWeight').textContent = `${(activeRM * (intensity/100)).toFixed(1)} kg`;
                document.getElementById('intensityInfo').textContent = `${intensity}% del RM actual`;
            }
        }

        // --- HISTORIAL ---
        function renderHistory() {
            const grid = document.getElementById('rmGrid');
            const lists = document.getElementById('exerciseHistoryLists');
            grid.innerHTML = "";
            lists.innerHTML = "";

            Object.keys(EX_NAMES).forEach(ex => {
                const profile = calculateRM(ex);
                
                // Card de Resumen
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl custom-shadow border border-slate-100 text-center";
                card.innerHTML = `
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">${EX_NAMES[ex]}</p>
                    <p class="text-2xl font-black text-slate-800">${profile ? profile.rm.toFixed(1) : '--'} <span class="text-xs">kg</span></p>
                    <p class="text-[8px] font-bold text-blue-500">R: ${profile ? profile.r2.toFixed(2) : '0.00'}</p>
                `;
                grid.appendChild(card);

                // Lista de registros
                const listContainer = document.createElement('div');
                listContainer.className = "bg-white rounded-2xl border border-slate-100 p-4 space-y-3";
                listContainer.innerHTML = `<h4 class="text-xs font-black text-slate-800 uppercase mb-2 border-b pb-2">${EX_NAMES[ex]}</h4>`;
                
                const entries = allData[ex];
                if (entries.length === 0) {
                    listContainer.innerHTML += `<p class="text-[10px] text-slate-400 italic">Sin datos registrados.</p>`;
                } else {
                    entries.forEach((e, i) => {
                        const row = document.createElement('div');
                        row.className = "flex items-center justify-between gap-2 p-2 bg-slate-50 rounded-lg group";
                        row.innerHTML = `
                            <div class="flex gap-3">
                                <div class="flex flex-col">
                                    <span class="text-[8px] font-bold text-slate-400 uppercase">Kg</span>
                                    <input type="number" value="${e.load}" onchange="editEntry('${ex}', ${i}, 'load', this.value)" class="w-12 bg-transparent font-bold text-xs focus:outline-none">
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[8px] font-bold text-slate-400 uppercase">m/s</span>
                                    <input type="number" step="0.01" value="${e.velocity.toFixed(2)}" onchange="editEntry('${ex}', ${i}, 'velocity', this.value)" class="w-12 bg-transparent font-mono text-xs focus:outline-none">
                                </div>
                            </div>
                            <button onclick="removeEntry('${ex}', ${i})" class="text-rose-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        `;
                        listContainer.appendChild(row);
                    });
                }
                lists.appendChild(listContainer);
            });
        }

        function editEntry(ex, i, field, val) {
            allData[ex][i][field] = parseFloat(val);
            saveData();
            renderHistory();
        }

        function removeEntry(ex, i) {
            allData[ex].splice(i, 1);
            saveData();
            renderHistory();
        }

        function saveData() {
            localStorage.setItem('vbt_data', JSON.stringify(allData));
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "vbt_backup_" + new Date().toLocaleDateString() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function resetDaily() { dailyRM = null; document.getElementById('dailyAdjustSection').classList.add('hidden'); updateUI(); }

        document.getElementById('planReps').addEventListener('input', () => updateUI());
        document.getElementById('planRPE').addEventListener('change', () => updateUI());
    </script>
</body>
</html>
