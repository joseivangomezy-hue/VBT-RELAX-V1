<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBT and Relax</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        input[type="range"] {
            accent-color: #3b82f6;
        }
        .tab-active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mode-active-profile {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            color: #1d4ed8 !important;
        }
        .mode-active-daily {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
            color: #047857 !important;
        }
        .editable-input {
            background: transparent;
            border-bottom: 1px dashed #cbd5e1;
            text-align: center;
            width: 60px;
            outline: none;
        }
        .editable-input:focus {
            border-bottom: 2px solid #3b82f6;
            color: #2563eb;
        }
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <!-- CONTENEDOR FIJO SUPERIOR -->
    <div class="sticky top-0 z-50 bg-slate-50/80 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto p-4 md:px-8 md:pt-6 md:pb-4">
            <header class="mb-4 text-center">
                <h1 class="text-3xl md:text-4xl font-black text-slate-800 tracking-tighter italic uppercase">VBT and Relax</h1>
                <p class="text-slate-500 text-sm font-medium">AnÃ¡lisis de Video & Auto-regulaciÃ³n</p>
            </header>

            <!-- NAVEGACIÃ“N -->
            <section class="bg-white p-1.5 rounded-2xl custom-shadow border border-slate-100 max-w-4xl mx-auto">
                <div class="flex flex-wrap gap-1 bg-slate-100 p-1 rounded-xl">
                    <button onclick="switchExercise('bench')" id="tab-bench" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Press Banca</button>
                    <button onclick="switchExercise('squat')" id="tab-squat" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Sentadilla</button>
                    <button onclick="switchExercise('deadlift')" id="tab-deadlift" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Peso Muerto</button>
                    <button onclick="switchExercise('pullup')" id="tab-pullup" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Dominadas</button>
                    <button onclick="switchExercise('history')" id="tab-history" class="flex-1 py-2 px-3 rounded-lg text-[10px] md:text-sm font-bold transition-all text-slate-500 hover:text-slate-700 bg-slate-200/50">ðŸ“Š Global</button>
                </div>
            </section>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- VISTA DE ANALIZADOR -->
        <main id="analyzerView" class="space-y-6">
            
            <!-- CARGA DE VIDEO Y FPS -->
            <section class="bg-white p-4 rounded-2xl custom-shadow border border-slate-100">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-xl border border-blue-100 shrink-0 w-full md:w-auto">
                        <div class="text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" /></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-blue-400 uppercase leading-none">V-1RM Referencia</p>
                            <p id="v1rmDisplay" class="text-xl font-mono font-bold text-blue-700 leading-tight">0.17 m/s</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 flex-grow items-end w-full">
                        <div class="w-full md:w-32">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">FPS Video</label>
                            <input type="number" id="fpsInput" value="30" oninput="saveSettings(); syncFramesWithFPS();" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-mono font-bold text-blue-600">
                        </div>
                        <div class="flex-grow">
                            <input type="file" id="videoInput" accept="video/*" class="hidden">
                            <button onclick="document.getElementById('videoInput').click()" class="w-full p-3.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition text-sm font-bold shadow-sm flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                Cargar Video del Levantamiento
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- COLUMNA IZQUIERDA -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="bg-black rounded-2xl overflow-hidden shadow-2xl aspect-video relative flex items-center justify-center border-4 border-slate-200">
                        <video id="videoPlayer" class="w-full h-full object-contain" playsinline muted></video>
                        <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-md px-3 py-1 rounded-full text-white text-xs pointer-events-none border border-white/10">
                            <span>Frame Actual: <b id="currentFrameDisplay">0</b></span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex gap-2">
                                <button onclick="stepFrame(-1)" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M8.445 14.832A1 1 0 0010 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" /></svg>
                                </button>
                                <button onclick="stepFrame(1)" class="p-3 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M11.555 14.832A1 1 0 0110 14V6a1 1 0 011.555-.832l6 4a1 1 0 010 1.664l-6 4z" /></svg>
                                </button>
                            </div>
                            <input type="range" id="frameSlider" value="0" min="0" step="1" class="flex-grow mx-4 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <button onclick="markFrame('start')" class="py-3 px-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-xl hover:bg-emerald-100 transition flex flex-col items-center">
                                <span class="text-[10px] font-bold uppercase opacity-60">Inicio Fase ConcÃ©ntrica</span>
                                <span id="startFrameText" class="text-lg font-mono font-bold">--</span>
                            </button>
                            <button onclick="markFrame('end')" class="py-3 px-4 bg-rose-50 text-rose-700 border border-rose-100 rounded-xl hover:bg-rose-100 transition flex flex-col items-center">
                                <span class="text-[10px] font-bold uppercase opacity-60">Fin Fase ConcÃ©ntrica</span>
                                <span id="endFrameText" class="text-lg font-mono font-bold">--</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Carga Serie (kg)</label>
                                <input type="number" id="currentLoadInput" placeholder="Ej: 90" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recorrido (cm)</label>
                                <input type="number" id="distanceInput" value="45" oninput="saveSettings()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-blue-600">
                            </div>
                        </div>

                        <div class="mb-6">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-3 text-center">Tipo de Registro</p>
                            <div class="flex gap-2">
                                <button onclick="setRegMode('profile')" id="btnModeProfile" class="mode-active-profile flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-blue-200">Perfil Base</button>
                                <button onclick="setRegMode('daily')" id="btnModeDaily" class="flex-1 py-3 px-2 rounded-xl text-xs font-bold transition-all border-2 border-transparent bg-slate-200 text-slate-500">Test Diario</button>
                            </div>
                        </div>

                        <button onclick="processCurrentMeasurement()" class="w-full py-4 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition font-black text-sm uppercase tracking-widest shadow-lg">Registrar Levantamiento</button>
                    </div>
                </div>

                <!-- COLUMNA DERECHA -->
                <div class="lg:col-span-5 space-y-6">
                    <!-- Resumen Ãºltima rep -->
                    <section id="lastRepSummary" class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100 hidden">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">Ãšltima RepeticiÃ³n</h2>
                        <div class="bg-slate-50 p-4 rounded-xl border flex items-center justify-between">
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Velocidad Media</p>
                                <p id="lastVM" class="text-3xl font-black text-slate-800">0.00 <span class="text-sm font-bold text-slate-500">m/s</span></p>
                            </div>
                        </div>
                    </section>

                    <!-- Resultados Perfil Base -->
                    <section class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4" id="exerciseTitle">Perfil Base</h2>
                        <div id="rmResultContainer" class="p-6 bg-slate-900 rounded-2xl text-white hidden shadow-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold uppercase text-slate-400 mb-1">1RM Base Estimado</p>
                                    <div class="flex items-baseline gap-2">
                                        <span id="rmValue" class="text-5xl font-black">0.0</span>
                                        <span class="text-xl font-bold">kg</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold uppercase text-slate-400">Fiabilidad RÂ²</p>
                                    <p id="r2Value" class="text-xl font-mono font-bold text-blue-400">0.000</p>
                                </div>
                            </div>
                        </div>
                        <div id="noDataWarning" class="text-center py-6 text-slate-400 text-xs italic">AÃ±ade 2+ cargas base para calcular.</div>
                    </section>

                    <!-- LISTA DE CARGAS EDITABLES -->
                    <section class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Cargas (Haz clic para editar)</h2>
                        <div id="currentExerciseList" class="space-y-3"></div>
                    </section>

                    <!-- AJUSTE DIARIO -->
                    <section id="dailyAdjustSection" class="bg-white p-6 rounded-2xl custom-shadow border-2 border-emerald-500 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm font-black text-emerald-600 uppercase tracking-widest">Estado Actual</h2>
                            <button onclick="resetDaily()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 uppercase underline">Reset Diario</button>
                        </div>
                        <div class="p-5 bg-emerald-600 rounded-xl text-white">
                            <p class="text-[10px] font-bold uppercase opacity-80 mb-1">1RM Real Hoy</p>
                            <div class="flex items-baseline justify-between">
                                <span id="dailyRMValue" class="text-5xl font-black">0.0</span>
                                <p id="dailyDiff" class="text-xs font-bold bg-white/20 px-2 py-1 rounded-lg">--</p>
                            </div>
                        </div>
                    </section>

                    <!-- PLANIFICADOR -->
                    <section id="plannerSection" class="bg-white p-6 rounded-2xl custom-shadow border border-slate-100 hidden">
                        <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 tracking-widest text-center">Calculadora de Cargas</h2>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-[9px] uppercase font-bold text-slate-400 mb-1">Reps</label>
                                <input type="number" id="planReps" value="5" min="1" max="10" class="w-full p-3 bg-slate-50 border rounded-xl font-bold">
                            </div>
                            <div>
                                <label class="text-[9px] uppercase font-bold text-slate-400 mb-1">RPE Objetivo</label>
                                <select id="planRPE" class="w-full p-3 bg-slate-50 border rounded-xl font-bold">
                                    <option value="10">RPE 10</option>
                                    <option value="9.5">RPE 9.5</option>
                                    <option value="9">RPE 9</option>
                                    <option value="8.5">RPE 8.5</option>
                                    <option value="8">RPE 8</option>
                                    <option value="7.5">RPE 7.5</option>
                                    <option value="7">RPE 7</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border text-center">
                            <p id="suggestedWeight" class="text-4xl font-black text-slate-800">0.0 kg</p>
                            <p id="intensityInfo" class="text-[9px] text-slate-400 font-bold uppercase mt-1"></p>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <!-- VISTA GLOBAL -->
        <main id="historyView" class="hidden space-y-8">
            <h2 class="text-2xl font-black text-slate-800 uppercase italic">Resumen Global</h2>
            <div id="rmGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <div class="bg-white p-6 rounded-3xl custom-shadow border text-center">
                <button onclick="clearAllData()" class="text-xs font-bold text-rose-500 uppercase tracking-widest border border-rose-200 px-6 py-3 rounded-xl hover:bg-rose-50">Borrar Todo</button>
            </div>
        </main>
    </div>

    <script>
        const V1RM = { bench: 0.17, squat: 0.30, deadlift: 0.15, pullup: 0.22 };
        const EX_NAMES = { bench: "Press Banca", squat: "Sentadilla", deadlift: "Peso Muerto", pullup: "Dominadas" };
        
        let currentExercise = 'bench';
        let registrationMode = 'profile'; 
        
        // Carga de datos
        let allData = JSON.parse(localStorage.getItem('vbt_data')) || { bench: [], squat: [], deadlift: [], pullup: [] };
        
        // Carga de configuraciÃ³n (FPS y Distancias)
        let settings = JSON.parse(localStorage.getItem('vbt_settings')) || {
            fps: 30,
            distances: { bench: 45, squat: 60, deadlift: 50, pullup: 55 }
        };

        let startFrame = null, endFrame = null;

        const videoPlayer = document.getElementById('videoPlayer');
        const frameSlider = document.getElementById('frameSlider');
        const fpsInput = document.getElementById('fpsInput');
        const distInput = document.getElementById('distanceInput');

        window.onload = () => {
            // Aplicar FPS guardados
            fpsInput.value = settings.fps;
            switchExercise(currentExercise);
        };

        function switchExercise(ex) {
            currentExercise = ex;
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.toggle('tab-active', el.id === `tab-${ex}`));
            
            if (ex === 'history') {
                document.getElementById('analyzerView').classList.add('hidden');
                document.getElementById('historyView').classList.remove('hidden');
                renderGlobalGrid();
            } else {
                document.getElementById('analyzerView').classList.remove('hidden');
                document.getElementById('historyView').classList.add('hidden');
                document.getElementById('v1rmDisplay').textContent = `${V1RM[ex].toFixed(2)} m/s`;
                document.getElementById('exerciseTitle').textContent = `Perfil: ${EX_NAMES[ex]}`;
                
                // Cargar distancia especÃ­fica de este ejercicio
                distInput.value = settings.distances[ex] || 45;
                
                updateUI();
            }
        }

        // Persistencia de configuraciÃ³n
        function saveSettings() {
            settings.fps = parseFloat(fpsInput.value) || 30;
            if (currentExercise !== 'history') {
                settings.distances[currentExercise] = parseFloat(distInput.value) || 45;
            }
            localStorage.setItem('vbt_settings', JSON.stringify(settings));
        }

        function setRegMode(mode) {
            registrationMode = mode;
            document.getElementById('btnModeProfile').classList.toggle('mode-active-profile', mode === 'profile');
            document.getElementById('btnModeDaily').classList.toggle('mode-active-daily', mode === 'daily');
        }

        document.getElementById('videoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            videoPlayer.src = URL.createObjectURL(file);
            videoPlayer.onloadedmetadata = () => syncFramesWithFPS();
        });

        function syncFramesWithFPS() {
            if (!videoPlayer.duration) return;
            const fps = parseFloat(fpsInput.value) || 30;
            frameSlider.max = Math.floor(videoPlayer.duration * fps);
            updateFrameDisplay();
        }

        function updateFrameDisplay() {
            const fps = parseFloat(fpsInput.value) || 30;
            const f = Math.round(videoPlayer.currentTime * fps);
            document.getElementById('currentFrameDisplay').textContent = f;
            frameSlider.value = f;
        }

        videoPlayer.addEventListener('timeupdate', updateFrameDisplay);
        frameSlider.addEventListener('input', () => {
            const fps = parseFloat(fpsInput.value) || 30;
            videoPlayer.currentTime = frameSlider.value / fps;
        });

        function stepFrame(d) { 
            const fps = parseFloat(fpsInput.value) || 30;
            videoPlayer.currentTime += d / fps; 
        }

        function markFrame(t) {
            const fps = parseFloat(fpsInput.value) || 30;
            const f = Math.round(videoPlayer.currentTime * fps);
            if (t === 'start') { startFrame = f; document.getElementById('startFrameText').textContent = f; } 
            else { endFrame = f; document.getElementById('endFrameText').textContent = f; }
        }

        function processCurrentMeasurement() {
            if (startFrame === null || endFrame === null) return;
            const load = parseFloat(document.getElementById('currentLoadInput').value);
            if (isNaN(load)) return;
            
            const fps = parseFloat(fpsInput.value) || 30;
            const time = (endFrame - startFrame) / fps;
            const velMedia = (parseFloat(distInput.value) / 100) / time;

            document.getElementById('lastRepSummary').classList.remove('hidden');
            document.getElementById('lastVM').textContent = velMedia.toFixed(2);

            if (registrationMode === 'daily') {
                allData[currentExercise] = allData[currentExercise].filter(e => !e.isDaily);
                allData[currentExercise].push({ load, velocity: velMedia, isDaily: true });
            } else {
                allData[currentExercise].push({ load, velocity: velMedia, isDaily: false });
            }
            
            saveData();
            updateUI();
            startFrame = endFrame = null;
            document.getElementById('startFrameText').textContent = document.getElementById('endFrameText').textContent = "--";
        }

        function saveData() { 
            localStorage.setItem('vbt_data', JSON.stringify(allData)); 
        }

        function calculateBaseRM(ex) {
            const entries = allData[ex].filter(e => !e.isDaily);
            if (entries.length < 2) return null;
            
            const x = entries.map(e => e.velocity);
            const y = entries.map(e => e.load);
            const n = x.length;
            const sX = x.reduce((a, b) => a + b, 0);
            const sY = y.reduce((a, b) => a + b, 0);
            const sXY = x.reduce((p, c, i) => p + (c * y[i]), 0);
            const sXX = x.reduce((a, b) => a + (b * b), 0);
            const den = (n * sXX - sX * sX);
            if (den === 0) return null;
            const slope = (n * sXY - sX * sY) / den;
            const intercept = (sY - slope * sX) / n;
            const rm = slope * V1RM[ex] + intercept;
            
            const yM = sY/n;
            const ssT = y.reduce((a,v) => a + Math.pow(v-yM, 2), 0);
            const ssR = y.reduce((a,v,i) => a + Math.pow(v - (slope*x[i] + intercept), 2), 0);
            return { rm, r2: ssT === 0 ? 1 : 1 - (ssR/ssT), slope };
        }

        function updateUI() {
            renderCurrentExerciseList();
            const profile = calculateBaseRM(currentExercise);
            let activeRMForPlanner = 0;

            if (profile) {
                document.getElementById('rmValue').textContent = profile.rm.toFixed(1);
                document.getElementById('r2Value').textContent = profile.r2.toFixed(3);
                document.getElementById('rmResultContainer').classList.remove('hidden');
                document.getElementById('noDataWarning').classList.add('hidden');
                activeRMForPlanner = profile.rm;

                const dailyEntry = allData[currentExercise].find(e => e.isDaily);
                if (dailyEntry) {
                    const dailyRM = dailyEntry.load + profile.slope * (V1RM[currentExercise] - dailyEntry.velocity);
                    document.getElementById('dailyRMValue').textContent = dailyRM.toFixed(1);
                    const diff = dailyRM - profile.rm;
                    document.getElementById('dailyDiff').textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}kg vs Base`;
                    document.getElementById('dailyAdjustSection').classList.remove('hidden');
                    activeRMForPlanner = dailyRM;
                } else {
                    document.getElementById('dailyAdjustSection').classList.add('hidden');
                }
                document.getElementById('plannerSection').classList.remove('hidden');
                updatePlan(activeRMForPlanner);
            } else {
                document.getElementById('rmResultContainer').classList.add('hidden');
                document.getElementById('plannerSection').classList.add('hidden');
                document.getElementById('dailyAdjustSection').classList.add('hidden');
                document.getElementById('noDataWarning').classList.remove('hidden');
            }
        }

        function renderCurrentExerciseList() {
            const listDiv = document.getElementById('currentExerciseList');
            listDiv.innerHTML = "";
            allData[currentExercise].forEach((e, i) => {
                const item = document.createElement('div');
                item.className = `p-3 rounded-xl text-sm border flex justify-between items-center ${e.isDaily ? 'bg-emerald-50 border-emerald-200 shadow-sm' : 'bg-slate-50 border-slate-200'}`;
                item.innerHTML = `
                    <div class="flex gap-3 items-center">
                        <span class="text-[9px] font-black uppercase ${e.isDaily ? 'text-emerald-600' : 'text-slate-400'}">${e.isDaily ? 'Daily' : 'Base'}</span>
                        <input type="number" step="0.5" value="${e.load}" onchange="editEntry(${i}, 'load', this.value)" class="editable-input font-bold text-slate-700">
                        <span class="text-xs text-slate-400">kg @</span>
                        <input type="number" step="0.01" value="${e.velocity.toFixed(2)}" onchange="editEntry(${i}, 'velocity', this.value)" class="editable-input font-mono text-blue-600">
                        <span class="text-xs text-slate-400">m/s</span>
                    </div>
                    <button onclick="removeEntry('${currentExercise}', ${i})" class="text-rose-400 hover:text-rose-600 text-lg">Ã—</button>
                `;
                listDiv.appendChild(item);
            });
        }

        function editEntry(index, field, value) {
            allData[currentExercise][index][field] = parseFloat(value);
            saveData();
            updateUI();
        }

        function removeEntry(ex, i) { allData[ex].splice(i, 1); saveData(); updateUI(); }

        function renderGlobalGrid() {
            const grid = document.getElementById('rmGrid');
            grid.innerHTML = "";
            Object.keys(EX_NAMES).forEach(ex => {
                const profile = calculateBaseRM(ex);
                grid.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl custom-shadow border text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">${EX_NAMES[ex]}</p>
                        <p class="text-3xl font-black text-slate-800">${profile ? profile.rm.toFixed(1) : '--'}</p>
                    </div>`;
            });
        }

        function updatePlan(activeRM) {
            const r = parseInt(document.getElementById('planReps').value) || 1;
            const rpe = parseFloat(document.getElementById('planRPE').value) || 10;
            const intensity = 100 - ((r - 1) * 3) - ((10 - rpe) * 2.5);
            const weight = (activeRM * (intensity/100)).toFixed(1);
            document.getElementById('suggestedWeight').textContent = `${weight} kg`;
            document.getElementById('intensityInfo').textContent = `${intensity.toFixed(1)}% de la intensidad de hoy`;
        }

        document.getElementById('planReps').addEventListener('input', updateUI);
        document.getElementById('planRPE').addEventListener('change', updateUI);
        function resetDaily() { allData[currentExercise] = allData[currentExercise].filter(e => !e.isDaily); saveData(); updateUI(); }
        function clearAllData() { if(confirm("Â¿EstÃ¡s seguro de que quieres borrar todos los datos?")) { allData = { bench: [], squat: [], deadlift: [], pullup: [] }; saveData(); renderGlobalGrid(); } }
    </script>
</body>
</html>
